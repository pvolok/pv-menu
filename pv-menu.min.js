(function(d){function f(a,b,h){var c=this;this.b=a;this.u=b;this.c=d.extend({},p,b,h);this.a=this.e=null;this.d=!0;a.on("mouseenter mouseleave",function(a){d(c).trigger(a.type+"_")});if("click"!=this.c.trigger)d(this).on("mouseenter_",function(){c.parentNode||clearTimeout(c.t)}).on("mouseleave_",function(){c.parentNode||(c.t=setTimeout(function(){c.f()},c.c.delay))});this.s();"delay"==this.c.trigger?this.q():"click"==this.c.trigger&&this.p();this.r();a.on("click",this.c.item_selector,function(a){d(c).trigger({type:"action",
originalEvent:a,closeMenu:d.proxy(c.f,c)})})}var p={item_selector:".menuitem",delay:300,orientation:"v",position:{my:"left top",at:"right top"}};f.prototype.s=function(){var a=this,b=this.c;this.b.on("mouseenter",b.item_selector,function(){a.i();a.g();a.a=d(this);a.h();a.k()});this.b.on("mouseleave",b.item_selector,function(){a.g()})};f.prototype.q=function(){var a=this,b=this.c,h;a.d=!1;this.b.on("mouseenter",b.item_selector,function(){a.d||(h=setTimeout(function(){a.d=!0;a.h();a.k()},b.delay))});
this.b.on("mouseleave",b.item_selector,function(){clearTimeout(h)});d(this).on("menuclose",function(){a.d=!1})};f.prototype.p=function(){var a=this,b=this.c;a.d=!1;this.j=function(b){a.m(b.target)||(a.d=!1,a.f())};this.b.on("click",b.item_selector,function(b){b.preventDefault();a.d=!0;a.a=d(this);a.h();a.k();a.o()});d(this).on("menuclose",function(){a.d=!1})};f.prototype.r=function(){var a=this,b=this.b,d=this.c.item_selector,c=this.c.orientation;b.find(d).attr("tabindex",-1);b.on("keydown",function(b){var e=
b.which;if(27==e)a.f();else if(13==e)a.a&&a.a.click();else if(e==("h"==c?39:40))a.n(1);else if(e==("h"==c?37:38))a.n(-1);else if(e==("h"==c?40:39)){if(a.k(!0),e=a.e)e.a=e.b.find(d).first(),e.h(!0)}else if(e==("h"==c?38:37))(e=a.parentNode)&&e.i();else return;b.preventDefault()});b.focus(function(){a.o()});b.blur(function(){a.parentNode||a.e||(a.g(),a.a=null,a.v())})};f.prototype.h=function(a){if(this.a){var b=this.a;(a||this.d||!b.data("submenu"))&&b.addClass("active")}};f.prototype.g=function(){if(this.a){var a=
this.a;this.e||a.removeClass("active")}};f.prototype.k=function(a){if(this.a&&(this.d||a)){a=this.a;var b=a.data("submenu");b&&("string"===typeof b&&(b=d(b).menu(this.u).data("menu"),a.data("submenu",b)),this.e=b,b.parentNode=this,b.b.appendTo(document.body).show().position(d.extend({of:a},this.c.position)).focus())}};f.prototype.i=function(){this.e&&(this.b.focus(),this.e.parentNode=null,this.e.close(),this.e=null)};f.prototype.close=function(){this.b.hide();this.i();this.g();this.a=null};f.prototype.f=
function(){this.parentNode?this.parentNode.f():(this.i(),this.g(),this.a=null,d(this).trigger("menuclose"))};f.prototype.n=function(a){var b=this.b.find(this.c.item_selector),f,c,g,e;this.a&&(f=this.a[0]);g=0;for(e=b.length;g<e;++g)if(f==b[g]){c=g+a;break}void 0===c?c=1==a?0:e-1:c>=e?c=0:0>c&&(c=e-1);this.g();this.a=d(b[c]);this.h(!0)};f.prototype.m=function(a){return this.b[0]==a||d.contains(this.b[0],a)||this.e&&this.e.m(a)};f.prototype.o=function(){this.j&&!this.l&&(d(document).on("click",this.j),
this.l=!0)};f.prototype.v=function(){this.j&&this.l&&(d(document).off("click",this.j),this.l=!1)};d.fn.menu=function(a,b){var d=this.data("menu");d||(d=new f(this,a,b),this.data("menu",d));return this};d.fn.contextMenu=function(a){function b(b){a.m(b.target)||f.f()}var f={f:function(){b&&d(document).off("click",b);a.close();a.parentNode=null}};this.data("menu",f);a=d(a).menu({}).data("menu");this.on("contextmenu",function(c){c.preventDefault();var g=d(window),e=a.b,k=c.pageX,l=c.pageY;e.appendTo(document.body).show();
a.parentNode=f;var m=e.outerWidth(),n=e.outerHeight();c.clientX+m>g.width()&&(k=Math.max(k-m,g.scrollLeft()));c.clientY+n>g.height()&&(l=Math.max(l-n,g.scrollTop()));e.css({left:k,top:l});d(document).on("click",b)});return this}})(jQuery);
