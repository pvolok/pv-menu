(function(c){function f(a,b,h){var d=this;this.b=a;this.u=b;this.f=b=c.extend({},p,b,h);this.a=this.d=null;this.c=!0;a.on("mouseenter mouseleave",function(a){c(d).trigger(a.type+"_")});if("click"!=b.trigger)c(this).on("mouseenter_",function(){d.parentNode||clearTimeout(d.t)}).on("mouseleave_",function(){d.parentNode||(d.t=setTimeout(function(){d.e()},b.delay))});this.s();"delay"==b.trigger?this.q():"click"==b.trigger&&this.p();this.r();a.on("click",b.item_selector,function(a){c(d).trigger({type:"action",
originalEvent:a,closeMenu:c.proxy(d.e,d)})})}var p={item_selector:".menuitem",delay:300,orientation:"v",position:{my:"left top",at:"right top"}};f.prototype.s=function(){var a=this,b=this.f;this.b.on("mouseenter",b.item_selector,function(){a.i();a.g();a.a=c(this);a.h();a.k()});this.b.on("mouseleave",b.item_selector,function(){a.g()})};f.prototype.q=function(){var a=this,b=this.f,h;a.c=!1;this.b.on("mouseenter",b.item_selector,function(){a.c||(h=setTimeout(function(){a.c=!0;a.h();a.k()},b.delay))});
this.b.on("mouseleave",b.item_selector,function(){clearTimeout(h)});c(this).on("menuclose",function(){a.c=!1})};f.prototype.p=function(){var a=this,b=this.f;a.c=!1;this.j=function(b){a.m(b.target)||(a.c=!1,a.e())};this.b.on("click",b.item_selector,function(b){b.preventDefault();a.c=!0;a.a=c(this);a.h();a.k();a.o()});c(this).on("menuclose",function(){a.c=!1})};f.prototype.r=function(){var a=this,b=this.b,c=this.f.item_selector,d=this.f.orientation;b.find(c).attr("tabindex",-1);b.on("keydown",function(b){var e=
b.which;if(27==e)a.e();else if(13==e)a.a&&a.a.click();else if(e==("h"==d?39:40))a.n(1);else if(e==("h"==d?37:38))a.n(-1);else if(e==("h"==d?40:39)){if(a.k(!0),e=a.d)e.a=e.b.find(c).first(),e.h(!0)}else if(e==("h"==d?38:37))(e=a.parentNode)&&e.i();else return;b.preventDefault()});b.focus(function(){a.o()});b.blur(function(){a.parentNode||a.d||(a.g(),a.a=null,a.v())})};f.prototype.h=function(a){if(this.a){var b=this.a;(a||this.c||!b.data("submenu"))&&b.addClass("active")}};f.prototype.g=function(){if(this.a){var a=
this.a;this.d||a.removeClass("active")}};f.prototype.k=function(a){if(this.a&&(this.c||a)){a=this.a;var b=a.data("submenu");b&&("string"===typeof b&&(b=c(b).menu(this.u).data("menu"),a.data("submenu",b)),this.d=b,b.parentNode=this,b.b.appendTo(document.body).show().position(c.extend({of:a},this.f.position)).focus())}};f.prototype.i=function(){this.d&&(this.b.focus(),this.d.parentNode=null,this.d.close(),this.d=null)};f.prototype.close=function(){this.b.hide();this.i();this.g();this.a=null};f.prototype.e=
function(){this.parentNode?this.parentNode.e():(this.i(),this.g(),this.a=null,c(this).trigger("menuclose"))};f.prototype.n=function(a){var b=this.b.find(this.f.item_selector),f,d,g,e;this.a&&(f=this.a[0]);g=0;for(e=b.length;g<e;++g)if(f==b[g]){d=g+a;break}void 0===d?d=1==a?0:e-1:d>=e?d=0:0>d&&(d=e-1);this.g();this.a=c(b[d]);this.h(!0)};f.prototype.m=function(a){return this.b[0]==a||c.contains(this.b[0],a)||this.d&&this.d.m(a)};f.prototype.o=function(){this.j&&!this.l&&(c(document).on("click",this.j),
this.l=!0)};f.prototype.v=function(){this.j&&this.l&&(c(document).off("click",this.j),this.l=!1)};c.fn.menu=function(a,b){var c=this.data("menu");c||(c=new f(this,a,b),this.data("menu",c));return this};c.fn.contextMenu=function(a){function b(b){a.m(b.target)||f.e()}var f={e:function(){b&&c(document).off("click",b);a.close();a.parentNode=null}};this.data("menu",f);a=c(a).menu({}).data("menu");this.on("contextmenu",function(d){d.preventDefault();var g=c(window),e=a.b,k=d.pageX,l=d.pageY;e.appendTo(document.body).show();
a.parentNode=f;var m=e.outerWidth(),n=e.outerHeight();d.clientX+m>g.width()&&(k=Math.max(k-m,g.scrollLeft()));d.clientY+n>g.height()&&(l=Math.max(l-n,g.scrollTop()));e.css({left:k,top:l});c(document).on("click",b)});return this}})(jQuery);
